# Tic-Tac-Toe для Telegram Web App

Проект представляет собой веб-приложение «крестики-нолики» для Telegram, запускаемое через Web App в боте. Пользователи подключаются к серверу по WebSocket, чтобы играть в режиме реального времени, а бот Telegraf обеспечивает безопасную авторизацию и выдачу ссылки на игру.

## Технологии
- **Node.js 18+** — основная платформа.
- **Express + Helmet + CORS** — HTTP-сервер, статика и базовая защита заголовков.
- **WebSocket (ws)** — обмен состоянием игры и очередью соперников.
- **PostgreSQL (pg)** — хранение профилей, статистики и достижений игроков.
- **Telegraf** — Telegram-бот, проверяющий подпись WebApp и передающий данные пользователя.
- **Vanilla JS + Telegram Web App JS** — фронтенд в каталоге `public/`.

## Как это работает
1. Фронтенд грузится из `public/index.html` и получает адреса сервера через `config.json` (учитываются прокси и HTTPS). Затем скрипты инициируют подключение к WebSocket и Telegram Web App SDK.【F:server/index.js†L25-L63】【F:public/index.html†L1-L17】
2. При входе данные пользователя проверяются `validateTelegramWebAppData`, после чего сервер сохраняет профиль в БД (`upsertUser`) и ставит игроков в очередь. Пара соперников получает идентификаторы X/O, а ходы проверяются и транслируются обеим сторонам через WebSocket.【F:server/index.js†L10-L116】【F:server/index.js†L170-L230】
3. Результаты матчей записываются в PostgreSQL, обновляются достижения и лидерборд, доступные через REST-эндпоинты `/leaders` и `/profile/:id`.【F:server/index.js†L65-L90】【F:server/db.js†L23-L107】

## Связь бэкенда и фронтенда
- Бэкенд обслуживает статику (`public/`) и отдаёт конфигурацию WebApp/WS через `/config.json`, чтобы фронт знал, куда подключаться в продакшене или за прокси.【F:server/index.js†L37-L68】
- Все игровые события (подключение, очередь, ходы, завершение) передаются по WebSocket. Фронт отправляет действия, сервер валидирует и рассылает актуальное состояние обоим игрокам.【F:server/index.js†L101-L219】
- Для авторизации фронт передаёт данные Telegram Web App, которые бэкенд проверяет и сохраняет, связывая статистику с реальным аккаунтом.【F:server/index.js†L10-L63】【F:server/db.js†L108-L165】

## Запуск локально
1. Установите зависимости: `npm install`.
2. Настройте окружение (`.env`):
   - `PORT` — порт HTTP/WS (по умолчанию 8080);
   - `BOT_TOKEN` — токен Telegram-бота;
   - `PUBLIC_URL` — внешний URL для WebApp (если отличен от локального);
   - Параметры подключения к PostgreSQL (`DATABASE_URL` или `PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD`, `PGDATABASE`, `PGSSL`).
3. Примените миграции/инициализацию схемы: `npm run migrate` (создаёт таблицы пользователей и достижений).【F:server/db.js†L23-L77】
4. Запустите сервер: `npm run start` (или `npm run dev` с `nodemon`). Статика доступна по `http://localhost:8080`, WebSocket слушает тот же хост.

## QR-код бота
Отсканируйте QR-код, чтобы открыть игрового бота в Telegram:

![QR-код бота](QRcode.jpg)

Лицензия проекта: MIT (см. `LICENSE`).
